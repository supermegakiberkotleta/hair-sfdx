# ObjectUpdateService Batch Optimization

## Обзор изменений

Класс `ObjectUpdateService` был оптимизирован для обработки больших объемов записей (более 50) с использованием батч-обработки, что решает проблему превышения лимита очереди.

## Проблема

При обновлении более 50 записей возникала ошибка:
```
System.LimitException: Too many queueable jobs added to the queue: 51
```

## Решение

### 1. Новый батч-класс `ObjectUpdateBatch`

**Файл:** `force-app/main/default/classes/ObjectUpdateBatch.cls`

**Особенности:**
- Реализует интерфейс `Database.Batchable<SObject>`
- Обрабатывает записи порциями (по умолчанию 200 записей за раз)
- Отслеживает статистику обработки (успешные, ошибки)
- Поддерживает настраиваемый размер батча

**Основные методы:**
- `start()` - создает QueryLocator для записей
- `execute()` - обрабатывает батч записей
- `finish()` - вызывается по завершении
- `startBatch()` - статический метод для запуска батча

### 2. Модификация `ObjectUpdateService`

**Изменения:**
- Добавлены константы для пороговых значений:
  - `BATCH_THRESHOLD = 50` - порог для переключения на батч-обработку
  - `MAX_SYNC_RECORDS = 200` - максимальное количество записей для синхронной обработки

- Добавлен метод `processWithBatch()` для запуска батч-обработки
- Модифицирован основной метод `updateObjects()` для автоматического выбора метода обработки

**Логика выбора:**
- **≤ 50 записей:** Синхронная обработка (как раньше)
- **> 50 записей:** Батч-обработка

### 3. Тестирование

**Новые тест-классы:**
- `ObjectUpdateBatchTest` - тесты для батч-класса
- Дополнительные тесты в `ObjectUpdateServiceTest` для проверки новой логики

**Покрытие тестами:**
- Тестирование конструктора батч-класса и инициализации
- Проверка метода `start()` и создания QueryLocator
- Тестирование метода `execute()` с прямым вызовом (без запуска батча)
- Обработка ошибок (неверный тип объекта, несуществующие поля)
- Тестирование метода `finish()`
- Проверка автоматического выбора между синхронной и батч-обработкой
- **Важно:** Тесты не запускают реальные батч-задачи для избежания превышения лимитов

## Использование

### Из Flow (без изменений)

Flow продолжает работать как раньше - никаких изменений в интерфейсе не требуется:

```apex
// Пример использования в Flow
ObjectUpdateService.UpdateRequest request = new ObjectUpdateService.UpdateRequest();
request.objectType = 'Lead';
request.recordIds = new List<String>{'00Q000000000001', '00Q000000000002'};
request.fieldsJson = '{"Status": "Closed Lost"}';

List<ObjectUpdateService.UpdateResult> results = 
    ObjectUpdateService.updateObjects(new List<ObjectUpdateService.UpdateRequest>{request});
```

### Прямое использование батч-класса

```apex
// Прямой запуск батч-обработки
Map<String, Object> fieldsMap = new Map<String, Object>{
    'Status' => 'Closed Lost',
    'Reason_for_closure__c' => 'Not interested'
};
List<String> recordIds = new List<String>{'00Q000000000001', '00Q000000000002'};

Id jobId = ObjectUpdateBatch.startBatch('Lead', fieldsMap, recordIds, 200);
```

## Преимущества

1. **Решение проблемы лимитов:** Больше нет ошибок при обработке > 50 записей
2. **Автоматический выбор:** Система сама выбирает оптимальный метод обработки
3. **Обратная совместимость:** Существующие Flow продолжают работать без изменений
4. **Масштабируемость:** Может обрабатывать тысячи записей
5. **Отслеживание:** Статистика обработки и детальная информация об ошибках

## Ограничения

1. **Асинхронность:** Батч-обработка выполняется асинхронно
2. **Время выполнения:** Батч может выполняться несколько минут для больших объемов
3. **Мониторинг:** Необходимо отслеживать статус батч-задач через Setup > Apex Jobs

## Мониторинг

Для отслеживания выполнения батч-задач:
1. Перейдите в Setup > Apex Jobs
2. Найдите задачу с именем "ObjectUpdateBatch"
3. Проверьте статус (Queued, Processing, Completed, Failed)

## Рекомендации

1. **Для < 50 записей:** Используйте обычный Flow (синхронная обработка)
2. **Для > 50 записей:** Система автоматически переключится на батч-обработку
3. **Для очень больших объемов:** Рассмотрите возможность разбиения на несколько запросов
4. **Мониторинг:** Регулярно проверяйте статус батч-задач в Setup > Apex Jobs

## Особенности тестирования

**Важно:** Тесты батч-класса не запускают реальные батч-задачи (`Database.executeBatch`), чтобы избежать превышения лимитов Salesforce на количество батч-задач в тестах. Вместо этого тесты:

- Проверяют создание экземпляра батч-класса
- Тестируют метод `start()` и создание QueryLocator
- Вызывают метод `execute()` напрямую с тестовыми данными
- Проверяют метод `finish()`
- Валидируют логику принятия решений в `ObjectUpdateService`

Это обеспечивает полное покрытие тестами без риска превышения лимитов.
